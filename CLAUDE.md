# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview
这是一个Chrome插件项目，支持Claude.ai和ChatGPT，将AI对话转化为可交互的思维导图。项目采用模块化架构，支持多平台。

### 📱 平台支持状态
| 平台 | 支持状态 | 特性 |
|------|----------|------|
| **Claude.ai** | ✅ 完全支持 | 智能过滤思考内容，优化压缩算法 |
| **ChatGPT** | ✅ 完全支持 | 标准消息抓取和主题分析 |

### 🏗️ 架构演进

#### v1 (MVP) - ✅ 已完成
**目标**：基础功能验证，点击插件图标抓取对话并在新标签页展示思维导图
**状态**：链路已打通（抓取→AI分析→Mermaid渲染）
**用途**：作为技术验证和完整导出功能保留

#### v2 (侧边栏版本) - ✅ 已完成
**目标**：AI对话页面右侧悬浮侧边栏，支持双向联动和实时更新
**核心特性**：
- 🎯 **双向联动**：点击节点→页面滚动，页面滚动→侧边栏高亮
- ⚡ **实时更新**：MutationObserver 监听新消息，自动增量分析
- 🎨 **自然交互**：树状折叠/展开、拖拽调整宽度

#### v3 (模块化重构) - ✅ 当前版本
**目标**：模块化架构，支持多平台，优化代码结构
**核心改进**：
- 🏗️ **适配器模式**：BaseAdapter + 平台特定适配器
- 🧩 **模块化**：独立的shared模块，便于维护和扩展
- 🐛 **问题修复**：Claude思考内容过滤，压缩算法优化
- 📱 **平台扩展**：新增ChatGPT完整支持

## 项目结构

### 🗂️ 当前文件结构
```
├── manifest.json          # Chrome插件配置
├── background.js          # 后台脚本：AI主题识别，压缩算法
├── content.js             # 主入口：平台检测和适配器加载
├── popup-simple.js        # 插件弹出页面：快捷入口
├── settings.js            # 设置页面逻辑
├── mindmap.html/js        # v1：完整导图导出（保留）

├── adapters/              # 🆕 适配器模块
│   ├── base-adapter.js    #     基础适配器类
│   ├── claude-adapter.js  #     Claude.ai专用适配器
│   └── chatgpt-adapter.js #     ChatGPT专用适配器

├── shared/                # 🆕 共享模块
│   └── sidebar.js         #     侧边栏核心逻辑

├── icons/                 # 插件图标（已更新为phosphor图标）
├── screenshots/           # 演示截图
│   ├── demo-claude.png    #     Claude.ai演示
│   └── demo-gpt.png       #     ChatGPT演示
├── sidebar.css            # 侧边栏样式
└── CLAUDE.md              # 项目说明和开发指南
```

## Architecture

### 🧩 核心组件

#### 1. **平台检测与适配器加载** (content.js)
- 自动检测当前平台（Claude.ai/ChatGPT）
- 动态加载对应适配器
- 统一的初始化流程

#### 2. **适配器系统** (adapters/)
- **BaseAdapter**: 统一的基础功能和接口
- **ClaudeAdapter**: Claude.ai特有逻辑
  - 智能过滤思考内容（移除"Pondered..."等前缀）
  - 优化的消息选择器
  - Claude特有的压缩算法
- **ChatGPTAdapter**: ChatGPT特有逻辑
  - 标准消息抓取
  - ChatGPT DOM结构适配

#### 3. **AI主题识别** (background.js)
- 调用AI分析对话，识别主题节点
- 智能压缩算法：头尾保留+关键信息提取
- 多种AI服务支持：Kimi、OpenAI、Claude、本地模型
- 降级机制：AI失败时使用问题导航模式

#### 4. **悬浮侧边栏** (shared/sidebar.js)
- **架构**：content script注入，独立样式隔离
- **布局**：右侧350px宽面板（250-500px可调），可拖拽调整
- **交互**：
  - 双向联动：点击主题→scrollIntoView() + 高亮动画
  - 消息导航：点击用户问题→跳转到对应位置
  - 实时更新：自动检测新消息并重新分析

### 🔧 技术特性

#### Claude.ai 特有优化
- **思考内容过滤**: 移除"Pondered..."等英文思考前缀
- **用户分析去除**: 清理"用户在阅读..."等分析性内容  
- **压缩算法**: 针对Claude长回复的智能压缩
- **选择器优化**: 适配Claude最新DOM结构

#### ChatGPT 支持
- **标准抓取**: 基于data-testid的可靠选择器
- **消息识别**: 准确区分用户和AI消息
- **格式处理**: 处理ChatGPT特有的消息格式

#### 通用功能
- **错误处理**: 友好的错误提示和自动重试
- **进度反馈**: 实时进度条和状态更新
- **性能优化**: 智能压缩，避免token超限

## Development Commands

### Chrome插件开发
```bash
# 加载开发版本
1. 打开 Chrome -> 扩展程序 -> 开发者模式
2. 点击"加载已解压的扩展程序"
3. 选择项目根目录

# 调试
- 后台脚本: 扩展程序页面 -> 背景页
- 内容脚本: 普通开发者工具
- 弹出页面: 右键插件图标 -> 检查弹出内容
```

### 开发原则
- **渐进式改进**：在确保现有功能正常的基础上进行小幅调整
- **模块化优先**：新功能优先考虑适配器扩展而非修改核心
- **平台兼容**：确保修改不破坏其他平台的功能
- **最小化修改**：只修改必要部分，避免过度重构

### 关键技术点
- **DOM稳定性**：定期测试平台DOM结构变化
- **适配器隔离**：平台特有逻辑封装在对应适配器中
- **性能优化**：对话>100轮时智能压缩，节流滚动事件200ms
- **准确率目标**：主题识别80%以上用户认同率

### 开发注意事项
⚠️ **重要**：不要过度开发！遵循以下原则：
1. **如果功能已经正常工作，只做必要的最小调整**
2. **每次只解决一个问题，不要同时修改多个部分**
3. **保持代码简洁，避免不必要的复杂性**
4. **优先修复问题而不是重写功能**
5. **测试每个小改动，确保不破坏现有功能**
6. **新平台支持通过适配器扩展，不修改核心逻辑**

## 错误处理与进度反馈规范

### 🚨 错误处理原则
1. **预见性错误处理** - 提前考虑可能的失败场景
2. **用户友好提示** - 避免技术术语，提供解决方案
3. **分级错误处理** - 网络错误→API错误→数据格式错误
4. **自动回退机制** - AI失败时自动使用问题导航模式
5. **详细日志记录** - 便于调试和问题定位（生产环境可关闭）

### 📊 进度反馈标准
1. **0-15秒超时** - 防止无限等待
2. **可视化进度条** - 绿色进度条，动画流畅
3. **状态文字提示** - 每个阶段都有明确说明
4. **渐进式加载** - 模拟真实进度到90%
5. **错误状态显示** - 友好的错误信息+解决建议

### 🔄 最新改进
1. **降级提示优化** - 显示有用的故障排除建议
2. **关闭按钮修复** - 使用事件监听器替代onclick
3. **日志输出清理** - 移除生产环境下的调试信息
4. **压缩算法优化** - 更好的Claude长回复处理

## 测试验证清单

### ✅ 基础功能测试
- [ ] Claude.ai对话抓取是否正常
- [ ] ChatGPT对话抓取是否正常
- [ ] AI分析是否成功
- [ ] 思维导图是否正确显示
- [ ] 节点点击是否显示对应消息

### 🔄 平台兼容性测试
- [ ] Claude.ai思考内容是否正确过滤
- [ ] ChatGPT消息是否正确识别
- [ ] 平台切换是否正常工作
- [ ] 适配器加载是否成功

### ⚠️ 错误处理测试
- [ ] 网络断开时的处理
- [ ] 无效API密钥的提示
- [ ] 15秒超时是否正常触发
- [ ] 问题导航模式回退是否工作
- [ ] 错误提示是否友好且有用

### 📊 进度反馈测试
- [ ] 进度条动画是否流畅
- [ ] 状态文字是否准确
- [ ] 错误提示关闭按钮是否工作
- [ ] 按钮状态是否正确变化

### 🔧 边界情况测试
- [ ] 空对话的处理
- [ ] 单轮对话的处理
- [ ] 超长对话(>100轮)的处理
- [ ] 特殊字符和格式的处理
- [ ] Claude思考内容混合的处理

### 📱 多平台测试
- [ ] Claude.ai各种对话类型
- [ ] ChatGPT各种对话类型
- [ ] 平台间功能一致性
- [ ] 适配器独立性验证

## 🚀 下一步计划

### 短期目标
- [ ] 持续优化压缩算法
- [ ] 改进错误提示的用户体验
- [ ] 性能监控和优化

### 中期目标
- [ ] 添加更多AI平台支持（Gemini等）
- [ ] 离线模式增强
- [ ] 用户自定义主题模板

### 长期目标
- [ ] 多语言支持
- [ ] 导出格式扩展
- [ ] 协作功能